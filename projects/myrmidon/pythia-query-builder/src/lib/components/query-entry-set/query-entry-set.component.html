<div class="bar-row">
  <button type="button" color="primary" mat-flat-button (click)="addEntry()">
    <mat-icon>add_circle</mat-icon> entry
  </button>
  <button
    type="button"
    color="warn"
    mat-icon-button
    (click)="reset()"
    matTooltip="Delete all the entries"
  >
    <mat-icon>clear</mat-icon>
  </button>
</div>
<table>
  <tbody>
    <tr
      *ngFor="
        let e of entries$ | async;
        let i = index;
        let first = first;
        let last = last
      "
    >
      <td class="fit-width">
        <span class="nr">{{ i + 1 }}. </span>
        <button
          type="button"
          mat-icon-button
          color="primary"
          matTooltip="Edit this entry"
          (click)="editEntry(e, i)"
        >
          <mat-icon>edit</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          color="primary"
          matTooltip="Add a new entry before this one"
          (click)="addEntry(i)"
        >
          <mat-icon>control_point_duplicate</mat-icon>
        </button>
        <button
          [disabled]="first"
          mat-icon-button
          type="button"
          matTooltip="Move this entry up"
          (click)="moveEntryUp(i)"
        >
          <mat-icon>arrow_upward</mat-icon>
        </button>
        <button
          [disabled]="last"
          mat-icon-button
          type="button"
          matTooltip="Move this entry down"
          (click)="moveEntryDown(i)"
        >
          <mat-icon>arrow_downward</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          color="warn"
          matTooltip="Delete this entry"
          (click)="deleteEntry(i)"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </td>
      <ng-container *ngIf="e.clause; else nonClause">
        <td [class.error]="e.error" class="attr">
          {{ e.clause.attribute.label }}
        </td>
        <td [class.error]="e.error" class="op">
          {{ e.clause.operator.label }}
        </td>
        <td [class.error]="e.error" class="value">{{ e.clause.value }}</td>
      </ng-container>
      <ng-template #nonClause>
        <td class="non-clause" [class.error]="e.error">{{ TYPES[e.type] }}</td>
        <td [class.error]="e.error"></td>
        <td [class.error]="e.error"></td>
      </ng-template>
      <td>
        <mat-icon *ngIf="e.error" color="warn" [matTooltip]="e.error"
          >error</mat-icon
        >
      </td>
    </tr>
  </tbody>
</table>
<ul *ngIf="errors$ | async as errors">
  <li *ngFor="let e of errors" style="color: red">{{ e }}</li>
</ul>
<mat-expansion-panel [expanded]="editedEntry" [disabled]="!editedEntry">
  <mat-expansion-panel-header
    >#{{ editedIndex + 1 }}</mat-expansion-panel-header
  >
  <pythia-query-entry
    [attrDefinitions]="attrDefinitions"
    [entry]="editedEntry"
    (entryChange)="saveEntry($event)"
    (editorClose)="closeEntry()"
  ></pythia-query-entry>
</mat-expansion-panel>
