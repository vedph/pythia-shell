<form [formGroup]="form" (submit)="save()">
  <!-- type -->
  <mat-form-field>
    <mat-label>type</mat-label>
    <mat-select [formControl]="type">
      <mat-option [value]="0">clause</mat-option>
      <mat-option [value]="1">AND</mat-option>
      <mat-option [value]="2">OR</mat-option>
      <mat-option [value]="3">AND NOT</mat-option>
      <mat-option [value]="4">(</mat-option>
      <mat-option [value]="5">)</mat-option>
    </mat-select>
    <mat-error
      *ngIf="$any(type).errors?.required && (type.dirty || type.touched)"
      >type required</mat-error
    >
  </mat-form-field>

  <!-- clause -->
  <form [formGroup]="clauseForm" *ngIf="type.value === 0">
    <div class="form-row">
      <!-- attribute -->
      <mat-form-field>
        <mat-label>attribute</mat-label>
        <mat-select [formControl]="attribute">
          <mat-optgroup
            *ngFor="let kv of attrGroups | keyvalue"
            [label]="kv.key"
          >
            <mat-option *ngFor="let d of kv.value" [value]="d">{{
              d.label
            }}</mat-option>
          </mat-optgroup>
        </mat-select>
        <mat-hint style="color: silver">{{ attribute.value?.tip }}</mat-hint>
        <mat-error
          *ngIf="
            $any(attribute).errors?.required &&
            (attribute.dirty || attribute.touched)
          "
          >attribute required</mat-error
        >
      </mat-form-field>

      <!-- operator -->
      <mat-form-field>
        <mat-label>operator</mat-label>
        <mat-select [formControl]="operator">
          <mat-optgroup
            class="opt-group"
            *ngFor="let kv of opGroups | keyvalue"
            [label]="kv.key"
          >
            <mat-option *ngFor="let d of kv.value" [value]="d">{{
              d.label
            }}</mat-option>
          </mat-optgroup>
        </mat-select>
        <mat-hint style="color: silver">{{ operator.value?.tip }}</mat-hint>
        <mat-error
          *ngIf="
            $any(operator).errors?.required &&
            (operator.dirty || operator.touched)
          "
          >operator required</mat-error
        >
      </mat-form-field>

      <!-- value -->
      <mat-form-field>
        <mat-label>value</mat-label>
        <input matInput [formControl]="value" (keydown.enter)="save()" />
        <mat-error
          *ngIf="$any(value).errors?.required && (value.dirty || value.touched)"
          >value required</mat-error
        >
        <mat-error
          *ngIf="
            $any(value).errors?.maxLength && (value.dirty || value.touched)
          "
          >value too long</mat-error
        >
      </mat-form-field>
    </div>

    <div formArrayName="args" *ngIf="args.controls.length">
      <fieldset>
        <legend>{{ operator.value?.label }} arguments</legend>
        <div
          *ngFor="
            let g of args.controls;
            let i = index;
            let first = first;
            let last = last
          "
        >
          <!-- child form -->
          <div [formGroupName]="i">
            <mat-form-field>
              <mat-label>{{ $any(g)["controls"].op.value.label }}</mat-label>
              <input
                matInput
                formControlName="value"
                placeholder="value"
                [type]="
                  $any(g)['controls'].op.value.numeric ? 'number' : 'text'
                "
              />
              <mat-error
                *ngIf="
                  $any(g)['controls'].value.errors?.required &&
                  ($any(g)['controls'].value.dirty ||
                    $any(g)['controls'].value.touched)
                "
                >value required</mat-error
              >
              <mat-error
                *ngIf="
                  $any(g)['controls'].value.errors?.maxLength &&
                  ($any(g)['controls'].value.dirty ||
                    $any(g)['controls'].value.touched)
                "
                >value too long</mat-error
              >
              <mat-error
                *ngIf="
                  $any(g)['controls'].value.errors?.min &&
                  ($any(g)['controls'].value.dirty ||
                    $any(g)['controls'].value.touched)
                "
                >value too low</mat-error
              >
              <mat-error
                *ngIf="
                  $any(g)['controls'].value.errors?.max &&
                  ($any(g)['controls'].value.dirty ||
                    $any(g)['controls'].value.touched)
                "
                >value too big</mat-error
              >
              <mat-error
                *ngIf="
                  $any(g)['controls'].value.errors?.pattern &&
                  ($any(g)['controls'].value.dirty ||
                    $any(g)['controls'].value.touched)
                "
                >invalid value</mat-error
              >
            </mat-form-field>
          </div>
        </div>
      </fieldset>
    </div>
  </form>

  <div>
    <button type="button" color="warn" mat-icon-button (click)="close()">
      <mat-icon>clear</mat-icon>
    </button>
    <button type="submit" color="primary" mat-icon-button>
      <mat-icon>check_circle</mat-icon>
    </button>
  </div>
</form>
